<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>NI-call.system</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea { width: 300px; height: 80px; }
    select, input[type="radio"] { margin-right: 10px; }
    button { margin: 5px; padding: 5px 10px; }
    .log-box { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>NI-call.system</h2>
  <button onclick="loadData()">🔁 更新</button>
  <button onclick="filterData('留守')">📞 留守+未架電</button>
  <button onclick="filterData('未架電')">📞 未架電のみ</button>
  <button onclick="resetFilter()">🔓 フィルター解除</button>
  <button onclick="shareInfo()">📤 共有（コピー）</button>

  <p>店舗名: <span id="name">--</span></p>
  <p>電話番号: <span id="phone">--</span> <button onclick="startCall()">📞 発信</button></p>

  <form id="form">
    <p>結果:
      <input type="radio" name="result" value="OK">OK
      <input type="radio" name="result" value="留守">留守
      <input type="radio" name="result" value="NG">NG
      <input type="radio" name="result" value="担当者不在">担当者不在
      <input type="radio" name="result" value="本社確認">本社確認
    </p>
    <p>受電者:
      <select id="receiver">
        <option>選択してください</option>
        <option>受付</option>
        <option>担当者</option>
        <option>オーナー</option>
        <option>店長</option>
        <option>NG</option>
      </select>
    </p>
    <p>メモ:<br>
      <textarea id="memo"></textarea>
    </p>
    <p>発信時刻: <span id="timestamp">--</span></p>
    <button type="button" onclick="prev()">⬅ 前へ</button>
    <button type="button" onclick="saveAndNext()">保存 ＆ 次へ ➡</button>
  </form>

  <div id="logContainer" class="log-box">
    <strong>過去の通話ログ:</strong>
    <div id="logs">（なし）</div>
  </div>

  <script>
    let records = [], original = [], index = 0;

    async function loadData() {
      const csv = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQJZk3P-8W87xA_3kO0c8XaDn3y1CGm5aBRPXmtXh4i0hPBZDg_he6b1lGBkACW-NMvvy54hV_nKHK7/pub?gid=0&single=true&output=csv').then(res => res.text());
      const rows = csv.trim().split('\n').slice(1);
      original = rows.map(r => {
        const [name, phone, result, receiver, memo, timestamp] = r.split(',');
        return { name, phone, result, receiver, memo, timestamp };
      });

      // ログからNG履歴を除外
      const logs = await fetch('http://localhost:3000/api/logs/all').then(res => res.json());
      const ngSet = new Set(logs.filter(l => l.result === 'NG').map(l => l.name + l.phone));
      records = original.filter(r => r.result !== 'NG' && !ngSet.has(r.name + r.phone));
      index = 0;
      render();
    }

    function render() {
      const rec = records[index];
      if (!rec) return;
      document.getElementById('name').textContent = rec.name;
      document.getElementById('phone').textContent = rec.phone;
      document.getElementById('timestamp').textContent = rec.timestamp || '--';
      document.getElementById('memo').value = rec.memo || '';
      document.getElementById('receiver').value = rec.receiver || '選択してください';
      document.querySelectorAll('input[name="result"]').forEach(r => r.checked = r.value === rec.result);
      loadLogs(rec.name, rec.phone);
    }

    function startCall() {
      const rec = records[index];
      const clean = rec.phone.replace(/[^0-9]/g, '');
      document.getElementById('timestamp').textContent = new Date().toLocaleString('ja-JP');
      window.open(`zoomphonecall://${clean}`, '_blank');
    }

    function saveAndNext() {
      const rec = records[index];
      const result = document.querySelector('input[name="result"]:checked')?.value;
      const receiver = document.getElementById('receiver').value;
      const memo = document.getElementById('memo').value;
      const timestamp = document.getElementById('timestamp').textContent;

      if (!result) return alert('結果を入力してください');
      if (!['留守', 'NG'].includes(result) && receiver === '選択してください') {
        return alert('受電者を選択してください');
      }

      const payload = {
        name: rec.name,
        phone: rec.phone,
        result,
        memo,
        receiver,
        timestamp
      };

      fetch('http://localhost:3000/api/write-result', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(() => {
        index++;
        render();
      });
    }

    function loadLogs(name, phone) {
      fetch(`http://localhost:3000/api/logs?name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}`)
        .then(res => res.json())
        .then(data => {
          const logDiv = document.getElementById('logs');
          if (data.length === 0) {
            logDiv.innerHTML = '（過去ログなし）';
          } else {
            logDiv.innerHTML = data.map(log => `
              <p>📅 ${log.timestamp} ｜📞 ${log.result}｜👤 ${log.receiver}｜📝 ${log.memo}</p>
            `).join('');
          }
        });
    }

    function prev() {
      if (index > 0) index--;
      render();
    }

    function filterData(mode) {
      if (mode === '留守') {
        records = original.filter(r => r.result === '留守' || !r.result);
      } else if (mode === '未架電') {
        records = original.filter(r => !r.result);
      }
      index = 0;
      render();
    }

    function resetFilter() {
      records = original.filter(r => r.result !== 'NG');
      index = 0;
      render();
    }

    function shareInfo() {
      const rec = records[index];
      const result = document.querySelector('input[name="result"]:checked')?.value || '';
      const receiver = document.getElementById('receiver').value || '';
      const memo = document.getElementById('memo').value || '';
      const timestamp = document.getElementById('timestamp').textContent || '';
      const text = `店舗名: ${rec.name}\n電話番号: ${rec.phone}\n結果: ${result}\n受電者: ${receiver}\nメモ: ${memo}\n発信時刻: ${timestamp}`;
      navigator.clipboard.writeText(text).then(() => alert('情報をコピーしました'));
    }

    window.onload = loadData;
  </script>
</body>
</html>
