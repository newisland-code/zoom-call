<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>NI-call.system</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea { width: 300px; height: 80px; }
    select, input[type="radio"] { margin-right: 10px; }
    button { margin: 5px; padding: 5px 10px; }
    .log-box { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>NI-call.system</h2>
  <button onclick="loadData()">ğŸ” æ›´æ–°</button>
  <button onclick="filterData('ç•™å®ˆ')">ğŸ“ ç•™å®ˆ+æœªæ¶é›»</button>
  <button onclick="filterData('æœªæ¶é›»')">ğŸ“ æœªæ¶é›»ã®ã¿</button>
  <button onclick="resetFilter()">ğŸ”“ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è§£é™¤</button>
  <button onclick="shareInfo()">ğŸ“¤ å…±æœ‰ï¼ˆã‚³ãƒ”ãƒ¼ï¼‰</button>

  <p>åº—èˆ—å: <span id="name">--</span></p>
  <p>é›»è©±ç•ªå·: <span id="phone">--</span> <button onclick="startCall()">ğŸ“ ç™ºä¿¡</button></p>

  <form id="form">
    <p>çµæœ:
      <input type="radio" name="result" value="OK">OK
      <input type="radio" name="result" value="ç•™å®ˆ">ç•™å®ˆ
      <input type="radio" name="result" value="NG">NG
      <input type="radio" name="result" value="æ‹…å½“è€…ä¸åœ¨">æ‹…å½“è€…ä¸åœ¨
      <input type="radio" name="result" value="æœ¬ç¤¾ç¢ºèª">æœ¬ç¤¾ç¢ºèª
    </p>
    <p>å—é›»è€…:
      <select id="receiver">
        <option>é¸æŠã—ã¦ãã ã•ã„</option>
        <option>å—ä»˜</option>
        <option>æ‹…å½“è€…</option>
        <option>ã‚ªãƒ¼ãƒŠãƒ¼</option>
        <option>åº—é•·</option>
        <option>NG</option>
      </select>
    </p>
    <p>ãƒ¡ãƒ¢:<br>
      <textarea id="memo"></textarea>
    </p>
    <p>ç™ºä¿¡æ™‚åˆ»: <span id="timestamp">--</span></p>
    <button type="button" onclick="prev()">â¬… å‰ã¸</button>
    <button type="button" onclick="saveAndNext()">ä¿å­˜ ï¼† æ¬¡ã¸ â¡</button>
  </form>

  <div id="logContainer" class="log-box">
    <strong>éå»ã®é€šè©±ãƒ­ã‚°:</strong>
    <div id="logs">ï¼ˆãªã—ï¼‰</div>
  </div>

  <script>
    let records = [], original = [], index = 0;

    async function loadData() {
      const csv = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQJZk3P-8W87xA_3kO0c8XaDn3y1CGm5aBRPXmtXh4i0hPBZDg_he6b1lGBkACW-NMvvy54hV_nKHK7/pub?gid=0&single=true&output=csv').then(res => res.text());
      const rows = csv.trim().split('\n').slice(1);
      original = rows.map(r => {
        const [name, phone, result, receiver, memo, timestamp] = r.split(',');
        return { name, phone, result, receiver, memo, timestamp };
      });

      // ãƒ­ã‚°ã‹ã‚‰NGå±¥æ­´ã‚’é™¤å¤–
      const logs = await fetch('http://localhost:3000/api/logs/all').then(res => res.json());
      const ngSet = new Set(logs.filter(l => l.result === 'NG').map(l => l.name + l.phone));
      records = original.filter(r => r.result !== 'NG' && !ngSet.has(r.name + r.phone));
      index = 0;
      render();
    }

    function render() {
      const rec = records[index];
      if (!rec) return;
      document.getElementById('name').textContent = rec.name;
      document.getElementById('phone').textContent = rec.phone;
      document.getElementById('timestamp').textContent = rec.timestamp || '--';
      document.getElementById('memo').value = rec.memo || '';
      document.getElementById('receiver').value = rec.receiver || 'é¸æŠã—ã¦ãã ã•ã„';
      document.querySelectorAll('input[name="result"]').forEach(r => r.checked = r.value === rec.result);
      loadLogs(rec.name, rec.phone);
    }

    function startCall() {
      const rec = records[index];
      const clean = rec.phone.replace(/[^0-9]/g, '');
      document.getElementById('timestamp').textContent = new Date().toLocaleString('ja-JP');
      window.open(`zoomphonecall://${clean}`, '_blank');
    }

    function saveAndNext() {
      const rec = records[index];
      const result = document.querySelector('input[name="result"]:checked')?.value;
      const receiver = document.getElementById('receiver').value;
      const memo = document.getElementById('memo').value;
      const timestamp = document.getElementById('timestamp').textContent;

      if (!result) return alert('çµæœã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      if (!['ç•™å®ˆ', 'NG'].includes(result) && receiver === 'é¸æŠã—ã¦ãã ã•ã„') {
        return alert('å—é›»è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
      }

      const payload = {
        name: rec.name,
        phone: rec.phone,
        result,
        memo,
        receiver,
        timestamp
      };

      fetch('http://localhost:3000/api/write-result', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(() => {
        index++;
        render();
      });
    }

    function loadLogs(name, phone) {
      fetch(`http://localhost:3000/api/logs?name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}`)
        .then(res => res.json())
        .then(data => {
          const logDiv = document.getElementById('logs');
          if (data.length === 0) {
            logDiv.innerHTML = 'ï¼ˆéå»ãƒ­ã‚°ãªã—ï¼‰';
          } else {
            logDiv.innerHTML = data.map(log => `
              <p>ğŸ“… ${log.timestamp} ï½œğŸ“ ${log.result}ï½œğŸ‘¤ ${log.receiver}ï½œğŸ“ ${log.memo}</p>
            `).join('');
          }
        });
    }

    function prev() {
      if (index > 0) index--;
      render();
    }

    function filterData(mode) {
      if (mode === 'ç•™å®ˆ') {
        records = original.filter(r => r.result === 'ç•™å®ˆ' || !r.result);
      } else if (mode === 'æœªæ¶é›»') {
        records = original.filter(r => !r.result);
      }
      index = 0;
      render();
    }

    function resetFilter() {
      records = original.filter(r => r.result !== 'NG');
      index = 0;
      render();
    }

    function shareInfo() {
      const rec = records[index];
      const result = document.querySelector('input[name="result"]:checked')?.value || '';
      const receiver = document.getElementById('receiver').value || '';
      const memo = document.getElementById('memo').value || '';
      const timestamp = document.getElementById('timestamp').textContent || '';
      const text = `åº—èˆ—å: ${rec.name}\né›»è©±ç•ªå·: ${rec.phone}\nçµæœ: ${result}\nå—é›»è€…: ${receiver}\nãƒ¡ãƒ¢: ${memo}\nç™ºä¿¡æ™‚åˆ»: ${timestamp}`;
      navigator.clipboard.writeText(text).then(() => alert('æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
    }

    window.onload = loadData;
  </script>
</body>
</html>
