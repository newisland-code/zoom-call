<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Zoom Phone ç™ºä¿¡ä¸€è¦§</title>
  <style>
    button.result-btn {
      margin-left: 5px;
      padding: 2px 6px;
      font-size: 12px;
      cursor: pointer;
    }
    td.result, td.timestamp {
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <h2>Zoom Phone ç™ºä¿¡ä¸€è¦§</h2>
  <button onclick="downloadCSV()">ğŸ“¥ çµæœCSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
  <button onclick="filterRetry()">ğŸ” å†æ¶é›»å¯¾è±¡ã ã‘è¡¨ç¤º</button>
  <button onclick="resetFilter()">ğŸ”“ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è§£é™¤</button>
  <br><br>
  <table id="table" border="1">
    <thead><tr><th>åº—èˆ—å</th><th>é›»è©±ç•ªå·</th><th>ç™ºä¿¡</th><th>çµæœ</th><th>æ—¥æ™‚</th></tr></thead>
    <tbody></tbody>
  </table>

  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQJZk3P-8W87xA_3kO0c8XaDn3y1CGm5aBRPXmtXh4i0hPBZDg_he6b1lGBkACW-NMvvy54hV_nKHK7/pub?gid=0&single=true&output=csv';
    let resultData = [];
    let originalRows = [];

    fetch(csvUrl)
      .then(res => res.text())
      .then(text => {
        const rows = text.trim().split('\n');
        const tbody = document.querySelector('#table tbody');

        rows.forEach((row, index) => {
          if (index === 0) return;

          const [name, phone] = row.split(',');
          if (!name || !phone) return;

          const cleanedPhone = phone.replace(/[^0-9]/g, '');
          const link = `zoomphonecall://${cleanedPhone}`;
          const rowId = `${name}-${cleanedPhone}`;
          const savedResult = localStorage.getItem(rowId);
          const savedTime = localStorage.getItem(`${rowId}_date`);

          resultData.push({ name, phone, result: savedResult || '', timestamp: savedTime || '' });

          const tr = document.createElement('tr');
          tr.dataset.result = savedResult || '';

          const resultCell = document.createElement('td');
          resultCell.className = 'result';

          const timeCell = document.createElement('td');
          timeCell.className = 'timestamp';

          if (savedResult) {
            resultCell.innerHTML = `<strong>${savedResult}</strong>`;
            timeCell.textContent = savedTime;
          } else {
            resultCell.innerHTML = `
              <button class="result-btn" onclick="setResult(this, 'âœ…æˆåŠŸ', '${rowId}', ${index - 1})">âœ…æˆåŠŸ</button>
              <button class="result-btn" onclick="setResult(this, 'ğŸ•“ç•™å®ˆ', '${rowId}', ${index - 1})">ğŸ•“ç•™å®ˆ</button>
              <button class="result-btn" onclick="setResult(this, 'âŒNG', '${rowId}', ${index - 1})">âŒNG</button>
            `;
          }

          tr.innerHTML = `
            <td>${name}</td>
            <td>${phone}</td>
            <td><a href="${link}">Zoomã§ç™ºä¿¡</a></td>
          `;
          tr.appendChild(resultCell);
          tr.appendChild(timeCell);
          tbody.appendChild(tr);
          originalRows.push(tr);
        });
      });

    function setResult(button, result, rowId, dataIndex) {
      const timestamp = new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
      const cell = button.parentElement;
      const dateCell = cell.nextElementSibling;

      cell.innerHTML = `<strong>${result}</strong>`;
      dateCell.textContent = timestamp;

      localStorage.setItem(rowId, result);
      localStorage.setItem(`${rowId}_date`, timestamp);

      if (resultData[dataIndex]) {
        resultData[dataIndex].result = result;
        resultData[dataIndex].timestamp = timestamp;
      }

      fetch('http://localhost:3000/api/write-result', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: resultData[dataIndex].name, result, timestamp })
      }).then(res => res.text()).then(console.log).catch(console.error);
    }

    function filterRetry() {
      const tbody = document.querySelector('#table tbody');
      tbody.innerHTML = '';
      originalRows.forEach(tr => {
        if (tr.dataset.result === 'ğŸ•“ç•™å®ˆ' || tr.dataset.result === 'âŒNG') {
          tbody.appendChild(tr);
        }
      });
    }

    function resetFilter() {
      const tbody = document.querySelector('#table tbody');
      tbody.innerHTML = '';
      originalRows.forEach(tr => tbody.appendChild(tr));
    }

    function downloadCSV() {
      const header = 'åº—èˆ—å,é›»è©±ç•ªå·,çµæœ,æ—¥æ™‚\n';
      const body = resultData
        .map(row => `${row.name},${row.phone},${row.result || ''},${row.timestamp || ''}`)
        .join('\n');
      const csv = header + body;
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'zoom_results.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
